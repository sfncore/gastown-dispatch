#!/usr/bin/env bash
# Pre-commit hook: Block AI artifacts from being committed
# To enable: git config core.hooksPath githooks

set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Patterns that should NEVER be committed
BLOCKED_DIRS=(
    "artifacts/"
    ".claude/"
    ".opencode/"
    ".factoryai/"
    ".droid/"
    ".amp/"
    ".gt/"
    ".agents/"
    ".llm/"
    ".chat/"
)

BLOCKED_PATTERNS=(
    "*.log"
    "*.trace"
    "*.dump"
    "*.patch"
    "*.diff"
    "*.prompt"
    "*transcript*"
    "*session*"
    "*conversation*"
)

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [[ -z "$STAGED_FILES" ]]; then
    exit 0
fi

VIOLATIONS=()

# Check for blocked directories
for dir in "${BLOCKED_DIRS[@]}"; do
    while IFS= read -r file; do
        if [[ -n "$file" && "$file" == "$dir"* ]]; then
            VIOLATIONS+=("$file")
        fi
    done <<< "$STAGED_FILES"
done

# Check for blocked patterns
for pattern in "${BLOCKED_PATTERNS[@]}"; do
    while IFS= read -r file; do
        if [[ -n "$file" ]]; then
            # Use bash pattern matching
            case "$file" in
                $pattern)
                    # Exclude legitimate source files
                    if [[ "$file" != src/* && "$file" != test/* && "$file" != scripts/* ]]; then
                        VIOLATIONS+=("$file")
                    fi
                    ;;
            esac
        fi
    done <<< "$STAGED_FILES"
done

# Remove duplicates
UNIQUE_VIOLATIONS=($(printf "%s\n" "${VIOLATIONS[@]}" | sort -u))

if [[ ${#UNIQUE_VIOLATIONS[@]} -gt 0 ]]; then
    echo -e "${RED}COMMIT BLOCKED: AI artifacts detected in staged files${NC}"
    echo ""
    echo -e "${YELLOW}The following files should not be committed:${NC}"
    echo ""
    for file in "${UNIQUE_VIOLATIONS[@]}"; do
        echo "  - $file"
    done
    echo ""
    echo "To fix:"
    echo "  1. Unstage the files:  git reset HEAD <file>"
    echo "  2. Move to artifacts:  mv <file> artifacts/<subfolder>/"
    echo "  3. Or run:             scripts/cleanup-ai-artifacts.sh"
    echo ""
    echo "If this is a false positive, add an allowlist entry to githooks/pre-commit"
    exit 1
fi

exit 0
